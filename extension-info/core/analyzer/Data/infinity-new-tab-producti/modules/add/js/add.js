"use strict";infinity.modules["add-add"]=function(){return new Vue({el:"#v-add",data:{categorys:[{id:"popular"},{id:"games"},{id:"shopping"},{id:"app"},{id:"music"},{id:"photos"},{id:"news"},{id:"social"},{id:"sports"},{id:"life"},{id:"education"},{id:"tech"},{id:"finance"},{id:"read"},{id:"others"}],currentType:"popular",currentList:[],staticLang:infinity.isZh()?"zh":"en",page:0,addedIcons:[],isShowMoreLoading:!1,isLockLoadMore:!1,isLoadError:!1,input:"",isSearching:!1,isSearchQuery:!1,isSearchDone:!1,iconPath:iconPath,isShowSearchResult:!1,custom:{isShow:!1,isAddDone:!1,colors:[{select:!1,id:"transparent",value:"transparent",border:"ccc",bgImage:"url(/icon/transparent.png)"},{select:!0,id:"1abc9c",value:"1abc9c",border:"1abc9c",bgImage:"none"},{select:!1,id:"2ecc71",value:"2ecc71",border:"2ecc71",bgImage:"none"},{select:!1,id:"33c5c5",value:"33c5c5",border:"33c5c5",bgImage:"none"},{select:!1,id:"3498db",value:"3498db",border:"3498db",bgImage:"none"},{select:!1,id:"9b59b6",value:"9b59b6",border:"9b59b6",bgImage:"none"},{select:!1,id:"34495e",value:"34495e",border:"34495e",bgImage:"none"},{select:!1,id:"f1c40f",value:"f1c40f",border:"f1c40f",bgImage:"none"},{select:!1,id:"e67e22",value:"e67e22",border:"e67e22",bgImage:"none"},{select:!1,id:"e74c3c",value:"e74c3c",border:"e74c3c",bgImage:"none"},{select:!1,id:"picker",value:"3b3333",border:"3b3333",bgImage:"none"}],selectColor:{id:"1abc9c",value:"1abc9c",border:"1abc9c",bgImage:"none"},croppedImage:null,isShowCustomAddLoading:!1,cusUrl:"",cusName:"",showText:"",customIconType:"text",searchAjax:!1}},created:function(){var e=this;e.moduleInit(),e.onOpen(),infinity.onMessage("reCheckIsAdded",function(){e.reCheckIsAdded()})},methods:{moduleInit:function(){var t=this;$(".i-add").one("transitionend",function(e){e.preventDefault(),t.setAllAddedIcons(),t.onReloadResponse(),setTimeout(function(){t.getPopular(),t.onInitCustom()},50),t.debouncedSearch=$.debounce(500,!1,t.search)})},openSetting:function(){$(".i-add").removeClass("i-side-show"),$(".main").removeClass("main-move"),infinity.import("settings",".side-all",function(){$(".i-settings").removeClass("i-side-hide"),$(".i-settings")[0].offsetHeight,$(".i-settings").addClass("i-side-show")})},close:function(){iView.hideSideBar()},onOpen:function(){$(".i-add").on("transitionend",function(e){0<=e.target.className.indexOf("i-add")&&e.target.className.indexOf("i-side-show")})},onsearch:function(){var e=this,t=document.getElementById("add-search").value;(t=t.trim())?t==e.input&&(e.isSearching=!0,e.currentType="search",e.doSearch()):e.getPopular()},doSearch:function(){this.isSearchQuery=!0,this.debouncedSearch()},search:function(){var t=this,e=document.getElementById("add-search").value;if(e){t.isSearchQuery=!0,t.isSearchDone=!1;var i=chrome.i18n.getUILanguage(),o=infinity.apiPro+"get-icons?type=search&lang="+i+"&page=0&keyword="+e;t.searchAjax&&t.searchAjax.abort(),t.searchAjax=$.ajax({url:o,dataType:"json"}).done(function(e){t.isSearchDone=!0,t.currentList=e.icons,t.currentList.length?t.isShowSearchResult=!0:t.isShowSearchResult=!1}).fail(function(){}).always(function(){t.isSearchQuery=!1})}},setAllAddedIcons:function(){for(var e=infinity.get("infinity-icons"),t=[],i=0;i<e.length;i++)for(var o=e[i],n=0;n<o.length;n++)t.push(o[n]);this.addedIcons=t},getPopular:function(){this.getList({id:"popular"})},onScrollBottom:function(e){var o=this,t=void 0,i=void 0;o.lockScroll||(i=e.target.clientHeight,t=e.target.scrollHeight,i+e.target.scrollTop!==t||o.isLockLoadMore||(o.isLockLoadMore=!0,infinity.get("infinity-cloud-icon-"+o.currentType,!0,function(e){var t=o.page+1;if(t<e.pages){o.isShowMoreLoading=!0;var i=e.data[t];setTimeout(function(){o.isShowMoreLoading=!1,o.currentList=o.currentList.concat(i),o.isLockLoadMore=!1,o.page=t},200)}else o.isLockLoadMore=!1,o.isShowMoreLoading=!1})))},getList:function(e){var t=this;t.searchAjax&&t.searchAjax.abort(),t.currentType=e.id,t.currentList=[],t.page=0,t.isLockLoadMore=!0,t.isSearching=!1,t.isSearchQuery=!1,t.isSearchDone=!1,t.isShowSearchResult=!1,infinity.get("infinity-cloud-icon-"+e.id,!0,function(e){null==e?t.isLoadError=!0:setTimeout(function(){t.currentList=e.data[t.page],t.isLockLoadMore=!1},100)})},reload:function(){var i=this;i.isLoadError=!1,chrome.tabs.getCurrent(function(e){var t={type:i.currentType,tabId:e.id};infinity.sendMessage("cloud-api-reload",t)})},onReloadResponse:function(){var i=this;infinity.onMessage("cloud-api-reload-response",function(t){chrome.tabs.getCurrent(function(e){e.id==t.tabId&&i.getList({id:i.currentType})})})},isAdded:function(e){var t=this.addedIcons;for(var i in t)if(t[i].url&&t[i].url==e)return!0;return!1},reCheckIsAdded:function(){this.currentList.map(function(e){e.isAdded=!1}),this.currentList=infinity.deepCopy(this.currentList)},getAddPosition:function(){var e=infinity.get("infinity-icons"),t=SETTING.row*SETTING.column;if(0==e.length&&e.push([]),e[_app.data.currentPage].length<t)return _app.data.currentPage;var i=e.length;for(var o in e)if(e[o].length<t){i=o;break}return parseInt(i)},onAdd:function(e,t){if(this.lockAdd)return!1;this.lockAdd=!0;var i=void 0;"official"==t?(i={uid:e.uid,name:infinity.i18n(e.name),url:e.url,src:e.src,iconType:t},infinity.sendMessage("ga-add-icon",{url:e.url,type:"官方"})):((i=e).iconType=t,infinity.sendMessage("ga-add-icon",{url:e.url,type:"自定义"}));var o=this.getAddPosition(),n=document.createElement("div");n.setAttribute("draggable","true"),n.className="icon-item-out OPACITY infinity-zoom-show";var s='\n\t\t                <div class="item-icon" url="'+i.url+'" data-icon="'+encodeURIComponent(JSON.stringify(i))+'">\n\t\t                \t<div class="item-icon-del"></div>\n\t\t                    <div class="icon-img BORDERRADIUS" style="background-image:url('+(i.src?i.src+iconPath:"")+");background-color:"+i.bgColor+';">'+(i.showText&&"text"==i.customType?i.showText:"")+'</div>\n\t\t                    <div class="icon-item-edit BORDERRADIUS"></div>\n\t\t                </div>\n\t\t                <div class="icon-name FONTCOLOR ICONNAMEOPACITY">'+i.name+"</div>\n\t\t        ";n.innerHTML=s,this.handleAdd(o,n,i,e),$(n).one(animationendEvent,function(){$(this).removeClass("infinity-zoom-show"),window.iDrag&&iDrag.listen(n.querySelector(".icon-img"))})},handleAdd:function(e,t,i,o){var n=this,s=void 0,c=(SETTING.row,SETTING.column,infinity.get("infinity-icons"));e>=c.length?(c.push([]),_app.data.groups=c,_app.render(),s=0==e?0:400,Vue.set(o,"isAdded",!0)):(Vue.set(o,"isAdded",!0),s=0,_app.data.currentPage!=e&&(s=400)),iView.slideToPage(e,s,function(){$(".group:nth-child("+(e+1)+")").append(t),c[e].push(i),infinity.set("infinity-icons",c),n.lockAdd=!1,infinity.sendMessage("icon-handle",{type:"add"}),infinity.sendMessage("backupToCloud")})},onInitCustom:function(){var o=this;function t(i){o.custom.colors.map(function(e,t){"picker"==e.id?(e.select=!0,e.value=i,e.border=i,o.custom.selectColor=JSON.parse(JSON.stringify(e))):e.select=!1})}infinity.require("color-picker",!0).then(function(){var e=new CP(document.querySelector(".color-item-picker"));e.set("rgb(255,255,255)"),e.on("exit",function(e,t,i){}),e.on("enter",function(e,t,i){}),e.on("start",function(e){t(e)}),e.on("drag",function(e){t(e)})})},onOpenCustomAdd:function(){this.clearCustom(),this.custom.isAddDone=!1,this.custom.isShow=!0,Vue.nextTick(function(){$("#add-custom-url")[0].focus()})},onCloseCustom:function(){this.custom.isShow=!1},clearCustom:function(){var i=this;i.custom.croppedImage=null,i.custom.isShowCustomAddLoading=!1,i.custom.cusUrl="",i.custom.cusName="",i.custom.showText="",i.custom.customIconType="text",i.custom.colors.map(function(e,t){"1abc9c"==e.id?(e.select=!0,i.custom.selectColor=e):e.select=!1})},onSelectColor:function(e){"picker"!=e.id&&(this.custom.colors.map(function(e,t){e.select=!1}),e.select=!0,this.custom.selectColor=e)},selectImage:function(){var i=this;infinity.chooseFile().then(function(t){i.custom.selectColor={select:!0,id:"transparent",value:"transparent",border:"ccc",bgImage:"url(/icon/transparent.png)"},i.custom.colors.map(function(e,t){"transparent"==e.id?e.select=!0:e.select=!1}),infinity.import("cropper","body",function(e){e.show(i.custom),i.custom.customIconType="image",e.onEditImage(t,!0,function(e){i.custom.croppedImage=e})})})},editImage:function(){var t=this;infinity.import("cropper","body",function(e){e.show(t.custom)})},removeImage:function(){this.custom.customIconType="text",this.custom.croppedImage=""},inputUrl:function(){var i=this;$.debounce(1500,!1,function(){var e=infinity.isUrl(i.custom.cusUrl);e.isValid&&$.get(e.str,function(e){var t="";try{t=$(e).filter(function(e,t){return"TITLE"==t.tagName})[0].text}catch(e){}"Redirect"!=t&&(i.custom.cusName=t,i.custom.showText=i.custom.cusName.substr(0,2).toUpperCase(),i.custom.showBgColor=!0)})})()},inputName:function(){this.custom.showText=this.custom.cusName.substr(0,2).toUpperCase()},onCustomAdd:function(){var t=this;if(!t.custom.isShowCustomAddLoading){t.custom.isShowCustomAddLoading=!0;var e=infinity.isUrl(t.custom.cusUrl),i="";i=e.isValid?e.str:t.custom.cusUrl;var o={customType:t.custom.customIconType,name:t.custom.cusName,url:i,showText:t.custom.showText,bgColor:t.custom.selectColor.value,uid:infinity.randomId(900),src:""};if(t.custom.croppedImage){t.custom.isShowCustomAddLoading=!0;var n={src:t.custom.croppedImage};infinity.sendMessage("upload2Qiuniu",n,function(e){e?(o.src=e,t.onAdd(o,"custom"),t.custom.isShowCustomAddLoading=!1,t.custom.isAddDone=!0):(t.custom.isShowCustomAddLoading=!1,infinity.alert({html:infinity.i18n("add_fail_due_to_network_error"),isShowCloseBtn:!0,isShowOkBtn:!0,okBtn:infinity.i18n("got_it")}))})}else t.onAdd(o,"custom"),t.custom.isShowCustomAddLoading=!1,t.custom.isAddDone=!0}},onAddNext:function(){this.clearCustom(),this.custom.isAddDone=!1,Vue.nextTick(function(){$("#add-custom-url")[0].focus()})},onCustomAddDone:function(){this.custom.isShow=!1}}})};