"use strict";var gmail=function(){var i,e=function(){function g(e){return e?e.textContent:null}return{getUnreadEmails:function(e){return new Promise(function(d,f){var h=new XMLHttpRequest;h.onreadystatechange=function(){var e,i;if(4==h.readyState)if(h.responseXML){var n=h.responseXML,t=g(n.querySelector("title"));if(t)try{t=/(\w+)@(\w+\.\w+)/.exec(t)[0]}catch(e){}for(var a=parseInt(g(n.querySelector("fullcount")),10),r=n.querySelectorAll("entry"),o=[],l=-1,c=0,s=r.length;c<s;c++){var m=r[c],u={id:g(m.querySelector("id")),title:g(m.querySelector("title")),summary:g(m.querySelector("summary")),link:(e=m.querySelector("link"),i="href",e?e.getAttribute(i):null),authorEmail:g(m.querySelector("author email")),authorName:g(m.querySelector("author name")),issued:g(m.querySelector("issued"))};u.issued&&(u.issued=new Date(u.issued).valueOf(),l=Math.max(l,u.issued)),o.push(u)}d({account:t,lastIssuedTime:l,count:a,emails:o})}else f()},h.onerror=f,h.open("GET","https://mail.google.com/mail/feed/atom?zx="+encodeURIComponent(e),!0),h.send(null)})}}}();return i=e,{check:function(){var c,s,m;return Promise.resolve(new Promise(function(e){chrome.storage.local.get("infinity-gmail",e)}).then(function(e){var i=e["infinity-gmail"];return i||(i={account:null,lastIssuedTime:-1,instanceId:"gmc"+parseInt(Date.now()*Math.random(),10),emails:[]}),{model:i}})).then(function(e){return c=e,i.getUnreadEmails(c.model.instanceId)}).then(function(e){var i,n=c.model.account,t=c.model.lastIssuedTime,a=e.emails;if(s=[],n===e.account)for(var r=0,o=a.length;r<o;r++){var l=a[r];l.issued>t&&s.push(l)}return m=e.count,c.model.account=e.account,c.model.lastIssuedTime=Math.max(t,e.lastIssuedTime),c.model.emails=a,i=c,new Promise(function(e){chrome.storage.local.set({"infinity-gmail":i.model},e)})}).then(function(){return{newEmails:s,unreadEmailCount:m}})},reset:function(){chrome.storage.local.remove("infinity-gmail")}}}(),bgGmail={delayTime:1,init:function(){var n=this;n.check(),chrome.alarms.onAlarm.addListener(function(e){"gmailCheck"==e.name&&n.check()}),infinity.onMessage("settingChange",function(e){if("isOpentGmailNotication"==e.type||"isShowGmailNum"==e.type){var i=infinity.get("infinity-settings");(i.isOpentGmailNotication||i.isShowGmailNum)&&n.check()}})},check:function(){var a=this,r=void 0;chrome.alarms.clear("gmailCheck"),(r=infinity.get("infinity-settings")).isOpentGmailNotication||r.isShowGmailNum?gmail.check().then(function(e){var i=r.gmailUnreadNum;e.unreadEmailCount>i&&infinity.sendMessage("updateGmailUnreadNum"),infinity.setting("gmailUnreadNum",e.unreadEmailCount),r=infinity.get("infinity-settings");var n=e.newEmails;if(r.isOpentGmailNotication){var t=void 0;n.map(function(e,i){t={type:"basic",contextMessage:e.authorName+"("+e.authorEmail+")",title:e.title,message:e.summary,iconUrl:"/icon/gmail.png",isClickable:!0},r.isOpentGmailRingNotication&&a.ring(),chrome.notifications.create(e.link,t,function(){})}),chrome.alarms.create("gmailCheck",{delayInMinutes:a.delayTime})}}).catch(function(e){chrome.alarms.create("gmailCheck",{delayInMinutes:a.delayTime})}):chrome.alarms.clear("gmailCheck")},ring:function(){var e=new Audio("/background/res/ring.mp3");e.play(),e.remove()}};